import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go

st.set_page_config(page_title="å…‰è°±æ•°æ®ç®¡ç†ç³»ç»Ÿ", layout="wide")
st.title("ä¸‰ç»´è§å…‰æŒ‡çº¹è°±å›¾åº“")

# ================== åˆå§‹åŒ– ==================
columns_order = [
    "æ—¥æœŸ", "AQI", "PM2.5æµ“åº¦", "O3æµ“åº¦", "NOx", "VOCs", "CO",
    "Ex(nm)", "Em(nm)", "å…‰è°±å³°å€¼", "EEMè°±å›¾"
]

if "data" not in st.session_state:
    st.session_state.data = pd.DataFrame(columns=columns_order)
if "files" not in st.session_state:
    st.session_state.files = {}  # ä¿å­˜ä¸Šä¼ æ–‡ä»¶å¯¹è±¡

# ================== è¡¨å•è¾“å…¥åŒºåŸŸ ==================
with st.expander("æ–°å¢æ•°æ®", expanded=True):
    with st.form("add_form", clear_on_submit=True):
        st.subheader("æ–°å¢å…‰è°±æ•°æ®")

        col1, col2, col3 = st.columns(3)
        with col1:
            date = st.date_input("ğŸ“… æ—¥æœŸ")
            AQI = st.number_input("ç©ºæ°”è´¨é‡æŒ‡æ•° (AQI)", min_value=0, step=1)
            NOx = st.number_input("NOx (ppb)", min_value=0.0, step=0.1)
        with col2:
            pm25 = st.number_input("PMâ‚‚.â‚…æµ“åº¦ (Î¼g/mÂ³)", min_value=0.0, step=0.1)
            o3 = st.number_input("Oâ‚ƒæµ“åº¦ (Î¼g/mÂ³)", min_value=0.0, step=0.1)
            VOCs = st.number_input("VOCs (ppb)", min_value=0.0, step=0.1)
        with col3:
            CO = st.number_input("CO (ppm)", min_value=0.0, step=0.01)
            ex = st.number_input("æ¿€å‘æ³¢é•¿ Ex (nm)", min_value=200, max_value=600, step=1)
            em = st.number_input("å‘å°„æ³¢é•¿ Em (nm)", min_value=250, max_value=700, step=1)

        peak = st.number_input("å…‰è°±å³°å€¼", min_value=0.0, step=0.1)
        uploaded_spectrum = st.file_uploader(
            "ğŸ“ ä¸Šä¼ å…‰è°±æ–‡ä»¶ï¼ˆ.csvã€.txt æˆ– .xlsxï¼‰", 
            type=["csv", "txt", "xlsx"]
        )
        submitted = st.form_submit_button("âœ… ç¡®è®¤æäº¤")

        if submitted:
            if uploaded_spectrum is not None:
                # ä¿å­˜æ–‡ä»¶å¯¹è±¡
                st.session_state.files[uploaded_spectrum.name] = uploaded_spectrum

                new_entry = {
                    "æ—¥æœŸ": date,
                    "AQI": AQI,
                    "PM2.5æµ“åº¦": pm25,
                    "O3æµ“åº¦": o3,
                    "NOx": NOx,
                    "VOCs": VOCs,
                    "CO": CO,
                    "Ex(nm)": ex,
                    "Em(nm)": em,
                    "å…‰è°±å³°å€¼": peak,
                    "EEMè°±å›¾": uploaded_spectrum.name
                }
                st.session_state.data = pd.concat(
                    [st.session_state.data, pd.DataFrame([new_entry])],
                    ignore_index=True
                )
                st.success(f"âœ… æ•°æ®å·²æˆåŠŸæ·»åŠ ï¼š{uploaded_spectrum.name}")
            else:
                st.warning("âš ï¸ è¯·ä¸Šä¼ å…‰è°±æ–‡ä»¶åå†æäº¤ã€‚")

# ================== æ•°æ®å±•ç¤º + åˆ é™¤åŠŸèƒ½ ==================
st.subheader("æ•°æ®è¡¨")

data_df = st.session_state.data.copy()

if not data_df.empty:
    # æ–°å¢ä¸€åˆ—â€œæ“ä½œâ€ï¼Œç”¨äºæ”¾ç½®åˆ é™¤æŒ‰é’®
    action_col = []
    for i, row in data_df.iterrows():
        delete_button = st.button("ğŸ—‘ åˆ é™¤", key=f"delete_{i}")
        if delete_button:
            file_name = row['EEMè°±å›¾']
            # åˆ é™¤å¯¹åº”æ–‡ä»¶å¯¹è±¡
            if 'files' in st.session_state and file_name in st.session_state.files:
                del st.session_state.files[file_name]
            # åˆ é™¤è¡Œ
            st.session_state.data.drop(index=i, inplace=True)
            st.session_state.data.reset_index(drop=True, inplace=True)
            st.success(f"âœ… å·²åˆ é™¤æ ·å“ï¼š{file_name}")
            st.experimental_rerun()
        action_col.append("ğŸ—‘ åˆ é™¤")

    # å°†â€œåˆ é™¤â€æŒ‰é’®åˆ—åŠ å…¥è¡¨æ ¼ä¸­æ˜¾ç¤º
    data_df["æ“ä½œ"] = action_col

    # å±•ç¤ºæ•°æ®è¡¨
    st.dataframe(data_df, use_container_width=True, hide_index=True)

else:
    st.info("æš‚æ— æ•°æ®ï¼Œè¯·åœ¨ä¸Šæ–¹æ·»åŠ æ ·å“ã€‚")

# ================== å…‰è°±å›¾å±•ç¤º ==================
if not st.session_state.data.empty:
    st.subheader("ğŸ”¬ å…‰è°±å›¾æŸ¥çœ‹")
    selected = st.selectbox(
        "é€‰æ‹©æ ·å“æ—¥æœŸæŸ¥çœ‹å…‰è°±", 
        st.session_state.data["æ—¥æœŸ"].astype(str).unique()
    )

    selected_row = st.session_state.data[st.session_state.data["æ—¥æœŸ"].astype(str) == selected].iloc[0]
    spectrum_file = selected_row["EEMè°±å›¾"]

    intensity = None
    if spectrum_file in st.session_state.files:
        uploaded_file = st.session_state.files[spectrum_file]
        try:
            if spectrum_file.endswith((".csv", ".txt")):
                df = pd.read_csv(uploaded_file, header=None)
            elif spectrum_file.endswith(".xlsx"):
                df = pd.read_excel(uploaded_file, header=None)
            intensity = df.values
            ex_vals = np.linspace(200, 400, intensity.shape[1])
            em_vals = np.linspace(300, 600, intensity.shape[0])
        except Exception as e:
            st.error(f"è¯»å–å…‰è°±æ–‡ä»¶å‡ºé”™: {e}")
    else:
        st.info(f"è¯·é‡æ–°ä¸Šä¼  {spectrum_file} æ–‡ä»¶ä»¥æ˜¾ç¤ºå…‰è°±")

    if intensity is not None:
        fig = go.Figure(data=[go.Surface(z=intensity, x=ex_vals, y=em_vals)])
        fig.update_layout(
            scene=dict(
                xaxis_title='Ex (nm)',
                yaxis_title='Em (nm)',
                zaxis_title='å¼ºåº¦'
            ),
            title=f"{selected} çš„ä¸‰ç»´è§å…‰å…‰è°±"
        )
        st.plotly_chart(fig, use_container_width=True)
else:
    st.info("å°šæœªæ·»åŠ ä»»ä½•æ ·å“æ•°æ®ï¼Œè¯·åœ¨ä¸Šæ–¹å¡«å†™åæäº¤ã€‚")
